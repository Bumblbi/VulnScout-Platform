import aiohttp
import asyncio
from typing import List, Dict
from config.settings import settings

class VulnerabilityScanner:
    def __init__(self):
        self.cve_api_url = settings.CVE_API_URL
        self.fstek_api_url = settings.FSTEK_API_URL
    
    async def check_cve_vulnerabilities(self, service: str, version: str) -> List[Dict]:
        async with aiohttp.ClientSession() as session:
            params = {
                'keywordSearch': f"{service} {version}",
                'resultsPerPage': 50
            }
            
            async with session.get(self.cve_api_url, params=params) as response:
                if response.status == 200:
                    data = await response.json()
                    return data.get('vulnerabilities', [])
                return []
    
    def scan(self, network_data: Dict) -> List[Dict]:
        vulnerabilities = []
        
        for host in network_data.get('hosts', []):
            for port in host.get('ports', []):
                if port['state'] == 'open':
                    service_vulns = asyncio.run(
                        self.check_cve_vulnerabilities(port['service'], port['version'])
                    )
                    
                    for vuln in service_vulns:
                        vulnerabilities.append({
                            'host': host['ip'],
                            'port': port['port'],
                            'service': port['service'],
                            'vulnerability': vuln
                        })
        
        return vulnerabilities